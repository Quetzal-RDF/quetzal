SELECT ?date ?avgval ?opcnt {
 {
	SELECT ?date (AVG(?value) AS ?avgval) WHERE {
		SERVICE <http://9.12.235.45:9091/openrdf-sesame/repositories/bjdiag2> {
	  		?x <http://www.ibm.com/health/bjdiag/PM25TBL#DATE> ?date;
	    	  <http://www.ibm.com/health/bjdiag/PM25TBL#VALUE> ?value
	    } 
	} GROUP BY ?date 
}
OPTIONAL {
	SELECT ?date ?diag_code (COUNT(DISTINCT ?empi) AS ?opcnt) WHERE {
			SERVICE <http://9.12.235.45:9091/openrdf-sesame/repositories/bjdiag2> {
		        ?x <http://www.ibm.com/health/bjdiag/DIAG_OUTPATIENT#EMPI> ?empi .
				?x  <http://www.ibm.com/health/bjdiag/DIAG_OUTPATIENT#DATE> ?date ;
					<http://www.ibm.com/health/bjdiag/DIAG_OUTPATIENT#DIAG_NAME> ?diag_code 				 
		    } 
		} GROUP BY ?date ?diag_code
	}
}